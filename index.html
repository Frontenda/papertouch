<!doctype html>
<html>
<head>
    <title>Socket.IO chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px Helvetica, Arial; }
        /*.button {
            position: absolute;
            border: 1px solid #00ff00;
        }
        #touchLog {
            position: absolute;
            left: 326px;
            top: 0px;
        }
        #imageLog {
            position: absolute;
            left: 0px;
            top: 350px;
            width: 400px;
            height: 400px;
            font-family: monospace;
            font-size: 4px;
        }
        .px {
            position: absolute;
            background: #000;
            width: 10px; height: 10px;
        }*/
        #box {
            width: 320px;
            height: 240px;
            border: 1px solid #cccccc;
            background-color: #eeeeee;
        }
    </style>

    <!--<script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="scripts/jsfeat.js"></script>
    <script type="text/javascript" src="scripts/alg.js"></script>-->
</head>
<body>
<div id="box"></div>
<!--<div id="button1" class="button" style="border-color: #ff0000;"></div>
<div id="button2" class="button" style="border-color: #00ff00;"></div>
<div id="button3" class="button" style="border-color: #0000ff;"></div>
<div id="button4" class="button" style="border-color: #ff00ff;"></div>
<div id="button5" class="button" style="border-color: #ffff00;"></div>
<div id="button6" class="button"></div>
<div id="button7" class="button"></div>
<div id="button8" class="button"></div>
<div id="button9" class="button"></div>
<div id="button10" class="button"></div>

<div id="touchLog"></div>
<div id="imageLog"></div>
<video id="webcam" width="320" height="240" loop muted style="display: none;"></video>
<div id="touchButtonLog" style="font-size: 30px; position: absolute; left: 10px; top: 4px;"></div>
<canvas id="canvas" width="320" height="240"></canvas>
<button id="findButtons" style="width: 300px; height: 100px; font-size: 40px; display: block;">Find buttons</button>-->

<style>
    .hidden {
        display: none;
    }
</style>
<script>
    window.TouchPaperDetector = function(container, userOptions) {
        var attachEvent = function() {},
            detachEvent = function() {},
            options = (function() {
                var options = {
                        width: 320,
                        height: 240,
                        videoURL: false,
                        showVideo: false
                    },
                    option;

                for (option in userOptions) {
                    if (userOptions.hasOwnProperty(option)) {
                        options[option] = userOptions[option];
                    }
                }
                return options;
            })(userOptions),

            video = (function() {
                var video = document.createElement("video");
                video.setAttribute("width", options.width.toString());
                video.setAttribute("height", options.height.toString());
                video.className = (!options.showVideo) ? "hidden" : "";
                video.setAttribute("loop", "");
                video.setAttribute("muted", "");
                container.appendChild(video);
                return video
            })(),
            playVideoWithTimeout = function() {
                setTimeout(function() {
                    video.play();
                }, 500);
            },
            initVideo = function() {
                // initialize web camera or upload video
                video.addEventListener('loadeddata', startLoop);

                if (options.videoURL) {
                    var source = document.createElement("source");
                    source.setAttribute("src", options.videoURL);
                    source.setAttribute("type", "video/mp4");
                    video.appendChild(source);
                    playVideoWithTimeout();
                } else {
                    window.navigator.webkitGetUserMedia({video: true}, function(stream) {
                        try {
                            video.src = window.URL.createObjectURL(stream);
                        } catch (error) {
                            video.src = stream;
                        }
                        playVideoWithTimeout();
                    }, function (error) {});
                }
            },

            ctx = (function() {
                var canvas = document.createElement("canvas");
                canvas.setAttribute("width", options.width.toString());
                canvas.setAttribute("height", options.height.toString());

                container.appendChild(canvas);
                return canvas.getContext("2d");
            })(),

            loopTimer = null,
            startLoop = function() {
                loopTimer = window.setInterval(nextFrame, 100);
            },
            stopLoop = function() {
                if (loopTimer) {
                    window.clearInterval(loopTimer);
                    loopTimer = null;
                }
            },
            nextFrame = function() {
                var imageData = captureFrame(),
                    matrix = imageDataToMatrix(imageData),
                    data = getContours(matrix, 100);
                    buttons = findShapes(data, []);

                imageData = dataToImageData(getContours(imageDataToMatrix(imageData), 100));
                ctx.putImageData(imageData, 0, 0);
                drawButtons(buttons);
            },
            captureFrame = function() {
                ctx.drawImage(video, 0, 0, options.width, options.height);
                return ctx.getImageData(0, 0, options.width, options.height);
            },
            imageDataToMatrix = function(imageData) {
                var x, y, matrix = [], index, r, g, b, a;
                for (y = 0; y < options.height; y++) {
                    matrix[y] = [];
                    for (x = 0; x < options.width; x++) {
                        index = (y * options.width + x) * 4;
                        r = imageData.data[index] ? imageData.data[index] : 0;
                        g = imageData.data[index + 1] ? imageData.data[index + 1] : 0;
                        b = imageData.data[index + 2] ? imageData.data[index + 2] : 0;
                        a = imageData.data[index + 3] ? imageData.data[index + 3] : 0;
                        matrix[y][x] = Math.round((r + g + b) / 3);
                    }
                }
                return matrix;
            },
            matrixToImageData = function(matrix) {
                var x, y, index,
                    imageData = ctx.createImageData(options.width, options.height);
                for (y = 0; y < options.height; y++) {
                    for (x = 0; x < options.width; x++) {
                        index = (y * options.width + x) * 4;
                        imageData.data[index] = matrix[y][x];
                        imageData.data[index + 1] = matrix[y][x];
                        imageData.data[index + 2] = matrix[y][x];
                        imageData.data[index + 3] = 255;
                    }
                }
                return imageData;
            },
            dataToImageData = function(matrix) {
                var x, y, index,
                    imageData = ctx.createImageData(options.width, options.height),
                    color;
                for (y = 0; y < options.height; y++) {
                    for (x = 0; x < options.width; x++) {
                        index = (y * options.width + x) * 4;
                        color = matrix[y][x] ? 0 : 255;
                        imageData.data[index] = color;
                        imageData.data[index + 1] = color;
                        imageData.data[index + 2] = color;
                        imageData.data[index + 3] = 255;
                    }
                }
                return imageData;
            },
            getContours = function(matrix, limit) {
                var x, y;
                for (y = 0; y < options.height; y++) {
                    for (x = 0; x < options.width; x++) {
                        matrix[y][x] = (matrix[y][x] > limit) ? 0 : 1;
                    }
                }
                return matrix;
            },
            drawButtons = function(buttons) {
                var button;
                for (var i = 0; i < buttons.length; i++) {
                    button = buttons[i].coords;
                    ctx.beginPath();
                    ctx.lineWidth = "2";
                    ctx.strokeStyle = "red";
                    ctx.rect(button[0][0], button[0][1], button[1][1] - button[0][0], button[1][0] - button[0][1]);
                    ctx.stroke();
                }
            },
            findShapes = function(data, existingButtons) {
                var createTouchRect = function(shape){
                            var minX = Infinity;
                            var maxX = -1;
                            var minY = Infinity;
                            var maxY = -1;

                            for(var i = 0; i<shape.length; i++){
                                if(shape[i][0] < minX) {
                                    minX = shape[i][0];
                                }
                                if(shape[i][0] > maxX) {
                                    maxX = shape[i][0]
                                }
                                if(shape[i][1] < minY) {
                                    minY = shape[i][1];
                                }
                                if(shape[i][1] > maxY){
                                    maxY = shape[i][1];
                                }
                            }
                            return [[minX, minY], [maxX, maxY]];
                        },
                        findShape = function(data) {
                            var shape=[];
                            var image = data;


                            var boundaryPixel = findBoundaryPixel(image);
                            if (!boundaryPixel) {
                                return null;
                            }
                            var startX = boundaryPixel.white[0];
                            var startY = boundaryPixel.white[1];

                            var prevX = startX;
                            var prevY = startY;
                            var curX = boundaryPixel.black[0];
                            var curY = boundaryPixel.black[1];
                            var iterates = 0;

                            while (true){
                                if(image[curX] && image[curX][curY] === 1) {
                                    shape.push([curX,curY]);
                                    image[curX][curY]+=1;
                                }

                                var nexts = chooseNextStep(prevX,prevY,curX,curY,image[curX] ? image[curX][curY] || 0 : 0);
                                prevX = curX;
                                prevY = curY;
                                curX = nexts[0];
                                curY = nexts[1];

                                if(curX === startX && curY === startY){
                                    break;
                                }
                                iterates++;
                                if (iterates > 5000) {
                                    return null;
                                }
                            }
                            return createTouchRect(shape);
                        },
                        chooseNextStep = function(prevX, prevY, curX, curY, direction) {
                            var isX = curX - prevX;
                            var isY = curY - prevY;
                            var stepX;
                            var stepY;
                            if(direction > 0){
                                direction = 1;
                            }else{
                                direction = -1;
                            }

                            if(isX === 0 && isY === 1) {
                                stepX = -1*direction;
                                stepY = 0;
                            }
                            if(isX === 0 && isY === -1 ) {
                                stepX = 1*direction;
                                stepY = 0;
                            }
                            if(isX === 1 && isY === 0){
                                stepX = 0;
                                stepY = 1*direction;
                            }
                            if(isX === -1 && isY === 0){
                                stepX = 0;
                                stepY = -1*direction;
                            }

                            var nextX = curX + stepX;
                            var nextY = curY + stepY;
                            return [nextX,nextY];
                        },
                        findBoundaryPixel = function(image){
                            var prev, cur;
                            var prevX, prevY;
                            for(var i = 0; i < image.length; i++){
                                for(var j = 0; j< image[i].length; j++){
                                    cur = image[i][j];
                                    if(cur === 1 && prev === 0){
                                        return {
                                            white:[prevX, prevY],
                                            black:[i,j]
                                        }
                                    }
                                    prev = cur;
                                    prevX = i;
                                    prevY = j;
                                }
                            }
                        },
                        subtract = function(data, button) {
                            var x0 = Math.max(button[0][1] - 10, 0),
                                    x1 = Math.min(button[1][1] + 10, data[0] ? data[0].length : 0),
                                    y0 = Math.max(button[0][0] - 10, 0),
                                    y1 = Math.min(button[1][0] + 10, data.length);

                            for (var row = y0; row <= y1; row++) {
                                for (var col = x0; col <= x1; col++) {
                                    if (data[row]) {
                                        data[row][col] = 0;
                                    }
                                }
                            }
                            return data;
                        },
                        isFilled = function(data) {
                            var filled = 0,
                                    height = data.length,
                                    width = data[0] ? data[0].length : 0;
                            for (var i = 0; i < height; i++) {
                                for (var j = 0; j < width; j++) {
                                    filled += data[i][j] ? 1 : 0;
                                }
                            }
                            return filled/(width*height) > 0.3;
                        },
                        isEmpty = function(data) {
                            for (var i = 0; i < data.length; i++) {
                                for (var j = 0; j < data[i].length; j++) {
                                    if (data[i][j]) {
                                        return false;
                                    }
                                }
                            }
                            return true;
                        },
                        isButton = function(button) {
                            var minSize = 10;
                            return (button[1][0] - button[0][0] > minSize) && (button[1][1] - button[0][1] > minSize);
                        },
                        getButtonHash = function(data, button) {
                            var sum = 0;
                            for (var row = button[0][0]; row <= button[1][0]; row++) {
                                for (var col = button[0][1]; col <= button[1][1]; col++) {
                                    if (data[row]) {
                                        sum += data[row][col];
                                    }
                                }
                            }
                            return sum;
                        },
                        cropArea = function(data, coords) {
                            var cropedData = [];
                            for (var row = coords[0][0], i = 0; row <= coords[1][0]; row++, i++) {
                                cropedData[i] = [];
                                for (var col = coords[0][1], j = 0; col <= coords[1][1]; col++, j++) {
                                    if (data[row]) {
                                        cropedData[i][j] = data[row][col] || 0;
                                    }
                                }
                            }
                            return cropedData;
                        },
                        uuid = (function() {
                            var index = 1;
                            return function() {
                                return index++;
                            }
                        })();
                var found = true,
                        button = null,
                        buttons = [];

                for (var i = 0; i < existingButtons.length; i++) {
                    button = findShape(cropArea(data, existingButtons[i].coords));
                    if (button) {
                        if (isButton(button)) {
                            buttons.push({
                                id: existingButtons[i].id,
                                sum: existingButtons[i].sum,
                                coords: button
                            });
                        }
                        data = subtract(data, button);
                    }
                }
                while (!isEmpty(data) && !isFilled(data) && found && buttons.length < 8) {
                    button = findShape(data);
                    if (button) {
                        if (isButton(button)) {
                            buttons.push({
                                id: uuid(),
                                sum: getButtonHash(data, button),
                                coords: button
                            });
                        }
                        data = subtract(data, button);
                    } else {
                        found = false;
                    }
                }
                return buttons;
            };


        initVideo();

        return {
            attachEvent: attachEvent,
            detachEvent: detachEvent,
            stop: stopLoop
        };
    };

    var touchDetector = TouchPaperDetector(document.getElementById("box"), {
        videoURL: "video/VID_20141018_161159.mp4",
        showVideo: true
    });

    /*var width = 320,
        height = 240;

    var video = document.getElementById('webcam'),
        canvas = document.getElementById('canvas'),
        ctx = canvas.getContext('2d');

    var processor = (function() {
        var img_u8 = new jsfeat.matrix_t(width, height, jsfeat.U8C1_t),
            img_gxgy = new jsfeat.matrix_t(width, height, jsfeat.S32C2_t),
            iterateImage = function(data, width, height, callback) {
                var row, col, index;
                for (row = 0; row < height; row++) {
                    for (col = 0; col < width; col++) {
                        index = (row * width + col);
                        callback(data[index], row, col);
                    }
                }
            },
            takePicture = function() {
                ctx.drawImage(video, 0, 0, width, height);
                return ctx.getImageData(0, 0, width, height);
            },
            logImage = function(bw) {
                var data = "",
                    height = bw.length,
                    width = bw[0].length;

                for (var row = 0; row < height; row++) {
                    for (var col = 0; col < width; col++) {
                        data += (bw[row][col] ? "1" : "&nbsp;");
                    }
                    data += "<br>";
                }
                document.getElementById("imageLog").innerHTML = data;
            },
            isEmptyPage = (function() {
                var emptyTimer = null,
                    isEmpty = function(data) {
                        var count = 0,
                            height = data.length,
                            width = data[0] ? data[0].length : 0;

                        for (var i = 0; i < data.length; i++) {
                            for (var j = 0; j < data[i].length; j++) {
                                if (data[i][j]) {
                                    count++;
                                }
                            }
                        }
                        return count/(width*height) < 0.001;
                    };
                return function(data) {
                    if (isEmpty(data)) {
                        if (emptyTimer) {
                            var newEmptyTimer = (new Date()).valueOf();
                            if (newEmptyTimer - emptyTimer > 3000) {
                                return true;
                            }
                        } else {
                            emptyTimer = (new Date()).valueOf();
                        }
                    } else {
                        emptyTimer = null;
                    }
                    return false;
                };
            })(),
            isEmptyRow = function(row) {
                for (var i = 0; i < row.length; i++) {
                    if (row[i] > 0) {
                        return false;
                    }
                }
                return true;
            },
            cropWhite = function(img) {
                var startRow = 0,
                    endRow = img.length;

                for (var i = 0; i < img.length; i++) {
                    if (isEmptyRow(img[i])) {
                        startRow = Math.max(startRow, i);
                    } else {
                        break;
                    }
                }
                for (var i = img.length - 1; i >= 0; i--) {
                    if (isEmptyRow(img[i])) {
                        endRow = Math.min(endRow, i);
                    } else {
                        break;
                    }
                }

                var startCol = 0;
                for (var col = 0; col < img[0].length; col++) {
                    var isEmpty = true;
                    for (var row = 0; row < img.length; row++) {
                        if (img[row][col] && img[row][col] > 0) {
                            isEmpty = false;
                            break;
                        }
                    }
                    if (isEmpty) {
                        startCol = Math.max(startCol, col);
                    } else {
                        break;
                    }
                }

                var endCol = img[0].length - 1;
                for (var col = img[0].length - 1; col >= 0; col--) {
                    var isEmpty = true;
                    for (var row = 0; row < img.length; row++) {
                        if (img[row][col] > 0) {
                            isEmpty = false;
                            break;
                        }
                    }
                    if (isEmpty) {
                        endCol = Math.min(endCol, col);
                    } else {
                        break;
                    }
                }

                img.splice(endRow, img.length - endRow);
                img.splice(0, startRow);
                for (var i = 0; i < img.length; i++) {
                    img[i].splice(endCol, img[i].length - endCol);
                    img[i].splice(0, startCol);
                }

                // add whitespaces
                var height = img.length,
                    width = img[0].length;

                for (var i = 0; i < height; i++) {
                    img[i] = [0].concat(img[i]);
                    img[i].push(0);
                }

                var arr = [];
                for (var i = 0; i < width + 2; i++) {
                    arr.push(0);
                }
                img = [arr].concat(img);
                img.push(arr);

                return img;
            },
            lookForTouches = function(imageData) {
                var bw = getBW(imageData),
                    whiteCoords = [];

                //logImage(bw);
                iterateImage(bw, width, height, function(v, row, col) {
                    if (v > 250) {
                        whiteCoords.push({ row: row, col: col });
                    }
                });
                var minRow = Infinity, maxRow = -1, minCol = Infinity, maxCol = -1;
                for (var i = 0; i < whiteCoords.length; i++) {
                    minRow = Math.min(minRow, whiteCoords[i].row);
                    minCol = Math.min(minCol, whiteCoords[i].col);
                    maxRow = Math.max(maxRow, whiteCoords[i].row);
                    maxCol = Math.max(maxCol, whiteCoords[i].col);
                }

                var result = {
                    min: {
                        row: minRow,
                        col: minCol
                    },
                    max: {
                        row: maxRow,
                        col: maxCol
                    }
                };
                return result;
                return result;
            },
            getBW = function(imageData, blackLimit) {
                jsfeat.imgproc.grayscale(imageData.data, width, height, img_u8);
                //fny(img_u8, img_u8, 100, 70);
                //jsfeat.imgproc.sobel_derivatives(img_u8, img_gxgy);
                //jsfeat.imgproc.scharr_derivatives(img_u8, img_gxgy);

                *//*var data_u32 = new Uint32Array(imageData.data.buffer);
                var alpha = (0xff << 24);
                var i = img_u8.cols*img_u8.rows, pix = 0;
                while(--i >= 0) {
                    pix = img_u8.data[i];
                    data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                }*//*

                *//*var data_u32 = new Uint32Array(imageData.data.buffer);
                var alpha = (0xff << 24);
                var i = img_u8.cols*img_u8.rows, pix=0, gx = 0, gy = 0;
                while(--i >= 0) {
                    gx = Math.abs(img_gxgy.data[i<<1]>>2)&0xff;
                    gy = Math.abs(img_gxgy.data[(i<<1)+1]>>2)&0xff;
                    pix = ((gx + gy)>>1)&0xff;
                    data_u32[i] = (pix << 24) | (gx << 16) | (0 << 8) | gy;
                }*//*
                ctx.putImageData(imageData, 0, 0);

                var limit = blackLimit || 100;
                var data = imageData.data;
                for (var i = 0; i < data.length; i+=4) {
                    if (data[i] > limit && data[i + 1] > limit && data[i + 2] > limit) {
                        data[i] = data[i + 1] = data[i + 2] = 255;
                    }
                }

                var imgBw = [],
                        v, size = imageData.data.length,
                        row = 0, col = 0;

                imgBw[0] = [];
                for (var i = 0; i < size; i++) {
                    row = Math.floor(Math.round(i/4)/width);
                    v = Math.round((imageData.data[i] + imageData.data[i + 1] + imageData.data[i + 2])/3) > 200 ? 0 : 1;
                    imgBw[row][col] = v;
                    i += 3;
                    col++;
                    if (col >= width && i < size - 1) {
                        row++;
                        imgBw[row] = [];
                        col = 0;
                    }
                }
                return imgBw;
            },
            buttons = [],
            findButtons = function() {
                var imageData = takePicture();
                var imgBw = getBW(imageData);
                //imgBw = cropWhite(imgBw);
                //imgBw.splice(imgBw.length - 10);
                *//*logImage(imgBw);*//*

                var button,
                    touchElement;

                buttons = findShapes(imgBw, buttons);
                console.log(buttons);

                for (var i = 0; i < buttonElements.length; i++) {
                    touchElement = buttonElements[i];
                    if (buttons[i]) {
                        button = buttons[i];
                        touchElement.style.top = button.coords[0][0] + "px";
                        touchElement.style.left = button.coords[0][1] + "px";
                        touchElement.style.height = (button.coords[1][0] - button.coords[0][0]) + "px";
                        touchElement.style.width = (button.coords[1][1] - button.coords[0][1]) + "px";
                        touchElement.style.display = "block";
                        touchLog.innerHTML += "detected button: " + button.id + ", hash: " + button.sum + "<br>";
                    } else {
                        touchElement.style.display = "none";
                    }
                }
            },
            getButtonHash = function(data, button) {
                var sum = 0;
                for (var row = button[0][0]; row <= button[1][0]; row++) {
                    for (var col = button[0][1]; col <= button[1][1]; col++) {
                        if (data[row]) {
                            sum += data[row][col];
                        }
                    }
                }
                return sum;
            },
            findClick = function() {
                var imageData = takePicture();
                var imgBw = getBW(imageData, 100),
                    hash,
                    found = false;

                //logImage(imgBw);
                if (isEmptyPage(imgBw)) {
                    touchButtonLog.innerHTML = "WHITE PAGE";
                    return null;
                } else {
                    touchButtonLog.innerHTML = "";
                    var touches = [];
                    for (var i = 0; i < buttons.length; i++) {
                        hash = getButtonHash(imgBw, buttons[i].coords);

                        if (hash - buttons[i].sum > 100) {
                            found = true;
                            touchButtonLog.innerHTML = "touch: " + buttons[i].id + " (" + (hash - buttons[i].sum) + ")<br>";
                            touches.push({
                                id: buttons[i].id,
                                hash: hash - buttons[i].sum
                            });
                            //return { id: buttons[i].id };
                        } else {
                            if (!found) {
                                touchButtonLog.innerHTML = hash - buttons[i].sum;//"touch: " + buttons[i].id + "<br>";
                            }
                        }
                    }
                    touches = touches.sort(function (touch1, touch2) {
                        return touch1.hash > touch2.hash ? 1 : -1;
                    });
                    if (touches.length > 0) {
                        return touches[0];
                    } else {
                        return null;
                    }
                }
            };

        return {
            findButtons: findButtons,
            findClick: findClick
            *//*getBw: getBW,

            lookForTouches: lookForTouches,*//*

        };
    })();

    var buttonElements = [];
    for (var i = 1; i < 10; i++) {
        buttonElements.push(document.getElementById("button" + i));
    }
    var touchElement = document.getElementById("touch"),
        touchLog = document.getElementById("touchLog"),
        touchButtonLog = document.getElementById("touchButtonLog");
    var streaming = (function() {
        var socket = io(),
            timer = null,

            sendScreenshot = function() {
                var click = processor.findClick();
                if (click) {
                    socket.emit("touch", JSON.stringify({
                        button: click
                    }));
                }
            },
            next = function() {
                sendScreenshot();
            },
            start = function() {
                timer = window.setInterval(sendScreenshot, 20);
            },
            stop = function() {
                if (timer) {
                    window.clearInterval(timer);
                    timer = null;
                }
            },
            findButtons = function() {
                processor.findButtons();
            };

        socket.on("findButtons", function() {
            console.log("looking for the buttons");
            streaming.findButtons();
        });
        return {
            start: start,
            stop: stop,
            next: next,
            findButtons: findButtons
        };
    })();

    if (0) {
        window.navigator.webkitGetUserMedia({video: true}, function(stream) {
            try {
                video.src = window.URL.createObjectURL(stream);
            } catch (error) {
                video.src = stream;
            }
            setTimeout(function() {
                video.play();
            }, 500);
        }, function (error) {});
    } else {
        var source = document.createElement("source");
        //source.setAttribute("src", "video/VID_20141018_030347.mp4");
        source.setAttribute("src", "video/VID_20141018_161159.mp4");
        source.setAttribute("type", "video/mp4");
        video.appendChild(source);
        setTimeout(function() {
            video.play();
        }, 500);
    }
    document.getElementById("findButtons").addEventListener("click", streaming.findButtons, false);
    video.addEventListener('loadeddata', streaming.start);*/
</script>
</body>
</html>