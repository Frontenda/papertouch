<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="description" content="A JavaScript Computer Vision Library">
    <title>JSFeat - JavaScript Computer Vision Library.</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
        #touch {
            position: absolute;
            border: 2px solid #00ff00;
        }
    </style>
</head>
<body>

<video id="webcam" width="320" height="240" loop muted style="display: none;">
    <!--<source src="video/VID_20141016_221939.ogv" type="video/ogg" />-->
</video>
<div id="touch"></div>
<div style=" width:640px;height:480px;">
    <canvas id="canvas" width="320" height="240"></canvas>

    <div id="no_rtc" class="alert alert-error" style="display:none;"></div>
    <div id="log" class="alert alert-info"></div>
</div>

<script type="text/javascript" src="scripts/jsfeat.js"></script>
<script type="text/javascript">
        "use strict";
        // lets do some fun
        var video = document.getElementById('webcam');
        var canvas = document.getElementById('canvas');

        var attempts = 0;
        var readyListener = function(event) {
            findVideoSize();
        };
        var findVideoSize = function() {
            if(video.videoWidth > 0 && video.videoHeight > 0) {
                video.removeEventListener('loadeddata', readyListener);
                onDimensionsReady(video.videoWidth, video.videoHeight);
            } else {
                if(attempts < 10) {
                    attempts++;
                    setTimeout(findVideoSize, 200);
                } else {
                    onDimensionsReady(320, 240);
                }
            }
        };
        var onDimensionsReady = function(width, height) {
            demo_app(width, height);
            window.requestAnimationFrame(tick);
        };

        video.addEventListener('loadeddata', readyListener);

        /*setTimeout(function() {
            video.play();
        }, 500);*/

        window.navigator.webkitGetUserMedia({video: true}, function(stream) {
            try {
                video.src = window.URL.createObjectURL(stream);
            } catch (error) {
                video.src = stream;
            }
            setTimeout(function() {
                video.play();
            }, 500);
        }, function (error) {});


        var options,ctx,canvasWidth,canvasHeight, touchElement;
        var img_u8, img_gxgy;

        var demo_opt = function(){
            this.blur_radius = 2;
            this.low_threshold = 20;
            this.high_threshold = 50;
        }

        function demo_app(videoWidth, videoHeight) {
            canvasWidth  = canvas.width;
            canvasHeight = canvas.height;
            ctx = canvas.getContext('2d');
            touchElement = document.getElementById("touch");

            ctx.fillStyle = "rgb(0,255,0)";
            ctx.strokeStyle = "rgb(0,255,0)";

            img_u8 = new jsfeat.matrix_t(320, 240, jsfeat.U8C1_t);
            img_gxgy = new jsfeat.matrix_t(320, 240, jsfeat.S32C2_t);

            options = new demo_opt();
        }

        function tick() {
            window.requestAnimationFrame(tick);
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx.drawImage(video, 0, 0, 320, 240);
                var imageData = ctx.getImageData(0, 0, 320, 240);
                jsfeat.imgproc.grayscale(imageData.data, 320, 240, img_u8);

                var r = options.blur_radius|0;
                var kernel_size = (r+1) << 1;

                jsfeat.imgproc.box_blur_gray(img_u8, img_u8, 11);
                //jsfeat.imgproc.canny(img_u8, img_u8, 1, 20);
                jsfeat.imgproc.sobel_derivatives(img_u8, img_gxgy);


                var data_u32 = new Uint32Array(imageData.data.buffer);
                var alpha = (0xff << 24);
                var i = img_gxgy.cols*img_gxgy.rows, pix=0, gx = 0, gy = 0;
                while(--i >= 0) {
                    pix = img_gxgy.data[i];
                    data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                    gx = Math.abs(img_gxgy.data[i<<1]>>2)&0xff;
                    gy = Math.abs(img_gxgy.data[(i<<1)+1]>>2)&0xff;
                    pix = ((gx + gy)>>1)&0xff;
                    data_u32[i] = (pix << 24) | (gx << 16) | (0 << 8) | gy;
                }

                var img_bw = [];
                var r, g, b, a, v, size = imageData.data.length;
                for (var i = 0; i < size; i++) {
                    //var v = Math.round(Math.random()*255);
                    v = r + g + b < 10 ? 0 : 255;
                    r = imageData.data[i];
                    g = imageData.data[i + 1];
                    b = imageData.data[i + 2];

                    img_bw.push(v);

                    /*imageData.data[i] = v;
                    imageData.data[i + 1] = v;
                    imageData.data[i + 2] = v;
                    imageData.data[i + 3] = 255;*/
                    i += 3;
                }

                ctx.putImageData(imageData, 0, 0);
                var touch = find(img_bw);
                touchElement.style.left = touch.min.col + "px";
                touchElement.style.top = touch.min.row + "px";
                touchElement.style.width = (touch.max.col - touch.min.col) + "px";
                touchElement.style.height = (touch.max.row - touch.min.row) + "px";

                //jsfeat.imgproc.canny(img_u8, img_u8, options.low_threshold|0, options.high_threshold|0);
                // render result back to canvas
                /*var data_u32 = new Uint32Array(imageData.data.buffer);
                var alpha = (0xff << 24);
                var i = img_u8.cols*img_u8.rows, pix = 0;
                while(--i >= 0) {
                    pix = img_u8.data[i];
                    data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                }
                ctx.putImageData(imageData, 0, 0);*/
            }
        }

    var isWhite = function(v) {
            return r > 250 && g > 250 && b > 250;
        },
        find = function(data) {
            var whiteCoords = [];
            iterateImage(data, 320, 240, function(v, row, col) {
                if (v > 250) {
                    whiteCoords.push({ row: row, col: col });
                }
            });
            var minRow = Infinity, maxRow = -1, minCol = Infinity, maxCol = -1;
            for (var i = 0; i < whiteCoords.length; i++) {
                minRow = Math.min(minRow, whiteCoords[i].row);
                minCol = Math.min(minCol, whiteCoords[i].col);
                maxRow = Math.max(maxRow, whiteCoords[i].row);
                maxCol = Math.max(maxCol, whiteCoords[i].col);
            }

            var result = {
                min: {
                    row: minRow,
                    col: minCol
                },
                max: {
                    row: maxRow,
                    col: maxCol
                }
            };
            return result;
        },
        iterateImage = function(data, width, height, callback) {
            var row, col, index;
            for (row = 0; row < height; row++) {
                for (col = 0; col < width; col++) {
                    index = (row * width + col);
                    callback(data[index], row, col);
                }
            }
        };
</script>
</body>
</html>